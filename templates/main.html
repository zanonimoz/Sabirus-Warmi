<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sabirus Warmi</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #333; --secondary: #666; --accent: #888; --danger: #d32f2f;
            --dark: #2c2c2c; --light: #f5f5f5; --sidebar-bg: #fafafa; --sidebar-border: #e0e0e0;
            --black: #000000; --success: #2e7d32; --warning: #f57c00;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--light); color: var(--dark); }
        
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: #F3F4F6; }
        ::-webkit-scrollbar-thumb { background: #999; border-radius: 5px; transition: all 0.3s ease; }
        ::-webkit-scrollbar-thumb:hover { background: #666; }
        * { scrollbar-width: thin; scrollbar-color: #999 #F3F4F6; }
        .sidebar { scrollbar-width: thin; scrollbar-color: #ccc #fafafa; }
        .sidebar::-webkit-scrollbar { width: 8px; }
        .sidebar::-webkit-scrollbar-track { background: #fafafa; }
        .sidebar::-webkit-scrollbar-thumb { background: #ddd; border-radius: 4px; }
        .sidebar::-webkit-scrollbar-thumb:hover { background: #bbb; }
        
        .sidebar { position: fixed; left: 0; top: 0; width: 260px; height: 100vh; background: var(--sidebar-bg); padding: 20px 0; overflow-y: auto; border-right: 1px solid var(--sidebar-border); }
        .logo { display: flex; align-items: center; padding: 0 20px 30px; border-bottom: 1px solid var(--sidebar-border); }
        .logo-icon { width: 40px; height: 40px; border-radius: 8px; margin-right: 12px; overflow: hidden; }
        .logo-icon img { width: 100%; height: 100%; object-fit: cover; }
        .logo-text { color: var(--dark); font-size: 18px; font-weight: 600; }
        .user-info { padding: 20px; background: white; margin: 20px; border-radius: 8px; border: 1px solid var(--sidebar-border); }
        .user-avatar { width: 45px; height: 45px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; font-weight: bold; margin-bottom: 10px; }
        .user-name { color: var(--dark); font-weight: 600; font-size: 14px; }
        .user-role { color: var(--secondary); font-size: 12px; margin-top: 3px; }
        .nav-section { margin-top: 30px; }
        .nav-label { color: var(--secondary); font-size: 11px; text-transform: uppercase; padding: 0 20px; margin-bottom: 10px; }
        .nav-link { display: flex; align-items: center; padding: 12px 20px; color: var(--secondary); text-decoration: none; transition: all 0.3s; border-left: 3px solid transparent; cursor: pointer; }
        .nav-link:hover, .nav-link.active { background: white; color: var(--primary); border-left-color: var(--primary); }
        .nav-icon { margin-right: 12px; font-size: 18px; width: 18px; height: 18px; display: inline-flex; align-items: center; justify-content: center; }
        
        .main-content { margin-left: 260px; min-height: 100vh; }
        .topbar { background: white; padding: 20px 30px; border-bottom: 1px solid var(--sidebar-border); display: flex; justify-content: space-between; align-items: center; }
        .page-title { font-size: 24px; font-weight: 600; }
        .logout-btn { background: var(--danger); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 500; display: inline-flex; align-items: center; transition: all 0.3s; }
        .logout-btn:hover { background: #b71c1c; transform: translateY(-2px); }
        .content { padding: 30px; }
        
        .card { background: white; border-radius: 8px; padding: 25px; border: 1px solid var(--sidebar-border); margin-bottom: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; border-radius: 8px; padding: 25px; border: 1px solid var(--sidebar-border); position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; }
        .stat-card.blue::before { background: #666; }
        .stat-card.green::before { background: #666; }
        .stat-card.orange::before { background: #999; }
        .stat-card.red::before { background: var(--danger); }
        .stat-card.purple::before { background: #9c27b0; }
        .stat-icon { width: 50px; height: 50px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 24px; margin-bottom: 15px; }
        .stat-card.blue .stat-icon { background: #f5f5f5; }
        .stat-card.green .stat-icon { background: #f5f5f5; }
        .stat-card.orange .stat-icon { background: #f5f5f5; }
        .stat-card.red .stat-icon { background: #ffebee; }
        .stat-card.purple .stat-icon { background: #f3e5f5; }
        .stat-value { font-size: 32px; font-weight: 700; margin-bottom: 5px; }
        .stat-label { color: var(--secondary); font-size: 14px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--accent); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: #f57c00; color: white; }
        .btn-black { background: var(--black); color: white; }
        .btn-black:hover { background: #222; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .btn:hover { transform: translateY(-2px); }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-control { width: 100%; padding: 12px; border: 1px solid var(--sidebar-border); border-radius: 8px; }
        .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(51, 51, 51, 0.05); }
        .form-check { display: flex; align-items: center; gap: 8px; margin-bottom: 15px; }
        .form-check input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .table th { background: var(--light); padding: 12px; text-align: left; font-weight: 600; border-bottom: 1px solid var(--sidebar-border); }
        .table td { padding: 12px; border-bottom: 1px solid var(--sidebar-border); }
        .table tr:hover { background: var(--light); }
        .badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; display: inline-block; }
        .badge-success { background: #e8f5e9; color: #2e7d32; }
        .badge-warning { background: #fff3e0; color: #e65100; }
        .badge-danger { background: #ffebee; color: #c62828; }
        .badge-info { background: #e3f2fd; color: #1976d2; }
        .badge-purple { background: #f3e5f5; color: #7b1fa2; }
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid; }
        .alert-warning { background: #fff3e0; color: #e65100; border-color: #f57c00; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 1000; }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; border-radius: 8px; padding: 30px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; position: relative; }
        .modal-header { font-size: 20px; font-weight: 600; margin-bottom: 20px; }
        .select-wrapper { position: relative; }
        .select-wrapper select { width: 100%; }
        .hidden { display: none; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .product-card { background: white; border-radius: 8px; overflow: hidden; border: 1px solid var(--sidebar-border); transition: all 0.3s; position: relative; }
        .product-card:hover { transform: translateY(-5px); }
        .product-image { width: 100%; height: 200px; background: var(--light); display: flex; align-items: center; justify-content: center; font-size: 48px; background-size: cover; background-position: center; background-repeat: no-repeat; object-fit: cover; }
        .product-info { padding: 15px; }
        .product-name { font-weight: 600; margin-bottom: 5px; }
        .product-price { color: var(--primary); font-weight: 700; font-size: 18px; }
        .product-badge { position: absolute; top: 10px; right: 10px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        .custom-dropdown { position: relative; width: 100%; }
        .custom-dropdown-button { width: 100%; padding: 12px 40px 12px 12px; border: 2px solid var(--sidebar-border); border-radius: 8px; background: white; text-align: left; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s; display: flex; align-items: center; justify-content: space-between; position: relative; }
        .custom-dropdown-button:hover { border-color: var(--primary); background: var(--light); }
        .custom-dropdown-button.active { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(51, 51, 51, 0.05); }
        .custom-dropdown-button .placeholder { color: #999; }
        .custom-dropdown-button .selected-text { color: var(--dark); flex: 1; }
        .custom-dropdown-button .arrow { width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 5px solid var(--secondary); transition: transform 0.3s; position: absolute; right: 15px; }
        .custom-dropdown-button.active .arrow { transform: rotate(180deg); }
        .custom-dropdown-menu { position: absolute; top: calc(100% + 5px); left: 0; width: 100%; max-height: 300px; overflow-y: auto; background: white; border: 2px solid var(--sidebar-border); border-radius: 8px; box-shadow: 0 8px 16px rgba(0,0,0,0.1); z-index: 1000; display: none; }
        .custom-dropdown-menu.show { display: block; animation: slideDown 0.2s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .custom-dropdown-search { position: sticky; top: 0; background: white; padding: 10px; border-bottom: 1px solid var(--sidebar-border); z-index: 10; }
        .custom-dropdown-search input { width: 100%; padding: 8px 12px; border: 1px solid var(--sidebar-border); border-radius: 6px; font-size: 13px; }
        .custom-dropdown-search input:focus { outline: none; border-color: var(--primary); }
        .custom-dropdown-item { padding: 12px 15px; cursor: pointer; transition: all 0.2s; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .custom-dropdown-item:last-child { border-bottom: none; }
        .custom-dropdown-item:hover { background: var(--light); }
        .custom-dropdown-item.selected { background: #e8f5e9; }
        .custom-dropdown-item.disabled { opacity: 0.5; cursor: not-allowed; background: #fafafa; }
        .custom-dropdown-item.disabled:hover { background: #fafafa; }
        .product-item-name { font-weight: 500; color: var(--dark); flex: 1; }
        .product-item-details { display: flex; gap: 10px; align-items: center; font-size: 13px; }
        .product-item-price { color: var(--primary); font-weight: 600; }
        .product-item-stock { padding: 3px 8px; background: #e3f2fd; color: #1976d2; border-radius: 4px; font-size: 11px; }
        .product-item-stock.low { background: #fff3e0; color: #e65100; }
        .product-item-stock.out { background: #ffebee; color: #c62828; }
        .no-products-message { padding: 20px; text-align: center; color: #999; font-size: 14px; }
        
        .cliente-grupo { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; border: 1px solid var(--sidebar-border); }
        .cliente-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; border-bottom: 2px solid var(--sidebar-border); margin-bottom: 15px; cursor: pointer; transition: all 0.3s; }
        .cliente-header:hover { background: var(--light); margin: -10px -20px 15px -20px; padding: 25px 20px 15px 20px; border-radius: 8px 8px 0 0; }
        .cliente-info { display: flex; align-items: center; gap: 15px; flex: 1; }
        .cliente-nombre { font-size: 20px; font-weight: 600; color: var(--primary); }
        .cliente-stats { display: flex; gap: 20px; font-size: 14px; color: var(--secondary); }
        .toggle-icon { transition: transform 0.3s; display: flex; align-items: center; }
        .toggle-icon.rotated { transform: rotate(180deg); }
        .items-lista { display: none; overflow: hidden; }
        .items-lista.show { display: block; }
        .item { background: var(--light); border-radius: 8px; padding: 15px; margin-bottom: 10px; border-left: 4px solid var(--primary); }
        .item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .item-id { font-weight: 600; color: var(--primary); }
        .item-total { font-size: 18px; font-weight: 700; color: var(--primary); }
        .item-info { display: flex; gap: 15px; font-size: 13px; color: var(--secondary); margin-bottom: 10px; flex-wrap: wrap; }
        .item-productos { background: white; border-radius: 6px; padding: 10px; margin-top: 10px; }
        .producto-detalle { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid var(--sidebar-border); }
        .producto-detalle:last-child { border-bottom: none; }
        
        .filtros-container { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .dropdown { position: relative; display: inline-block; }
        .dropdown-btn { padding: 10px 20px; border: 2px solid var(--sidebar-border); background: white; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s; display: flex; align-items: center; gap: 8px; }
        .dropdown-btn:hover { border-color: var(--primary); background: var(--light); }
        .dropdown-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .dropdown-btn svg { width: 16px; height: 16px; }
        .dropdown-content { display: none; position: absolute; background: white; min-width: 200px; box-shadow: 0 8px 16px rgba(0,0,0,0.1); border-radius: 8px; z-index: 1; margin-top: 5px; border: 1px solid var(--sidebar-border); max-height: 300px; overflow-y: auto; }
        .dropdown-content.show { display: block; }
        .dropdown-item { padding: 12px 16px; cursor: pointer; transition: all 0.2s; font-size: 14px; border-bottom: 1px solid var(--sidebar-border); }
        .dropdown-item:last-child { border-bottom: none; }
        .dropdown-item:hover { background: var(--light); }
        .dropdown-item.active { background: var(--primary); color: white; font-weight: 500; }
        
        @media (max-width: 768px) { .grid-2 { grid-template-columns: 1fr; } }

        .producto-agotado {
            position: relative;
            opacity: 0.85;
        }
        
        .producto-agotado::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(211, 47, 47, 0.03) 10px,
                rgba(211, 47, 47, 0.03) 20px
            );
            pointer-events: none;
            border-radius: 8px;
        }
        
        .producto-agotado .product-image {
            position: relative;
        }        
        
        .producto-agotado .product-image::before {
            content: 'AGOTADO';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-20deg);
            background: rgba(211, 47, 47, 0.95);
            color: white;
            padding: 8px 25px;
            font-weight: 700;
            font-size: 18px;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(211, 47, 47, 0.4);
            z-index: 5;
            letter-spacing: 2px;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo">
            <div class="logo-icon">
                <img src="/static/icono.png" alt="Sabirus Warmi">
            </div>
            <div class="logo-text">Sabirus Warmi</div>
        </div>
        <div class="user-info">
            <div class="user-avatar">A</div>
            <div class="user-name">Admin Demo</div>
            <div class="user-role">Administrador</div>
        </div>
        <div class="nav-section">
            <div class="nav-label">Principal</div>
            <div class="nav-link" data-view="dashboard" onclick="showView('dashboard', this)">
                <span class="nav-icon">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"/>
                        <rect x="14" y="3" width="7" height="7"/>
                        <rect x="14" y="14" width="7" height="7"/>
                        <rect x="3" y="14" width="7" height="7"/>
                    </svg>
                </span>Panel
            </div>
        </div>
        <div class="nav-section">
            <div class="nav-label">Gesti√≥n</div>
            <div class="nav-link" data-view="productos" onclick="showView('productos', this)">
                <span class="nav-icon">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                        <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                        <line x1="12" y1="22.08" x2="12" y2="12"/>
                    </svg>
                </span>Productos
            </div>
            <div class="nav-link" data-view="ventas" onclick="showView('ventas', this)">
                <span class="nav-icon">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6v6l4 2"/>
                    </svg>
                </span>Ventas
            </div>
            <div class="nav-link" data-view="alquileres" onclick="showView('alquileres', this)">
                <span class="nav-icon">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        <polyline points="9 22 9 12 15 12 15 22"/>
                    </svg>
                </span>Alquileres
            </div>
            <div class="nav-link" data-view="clientes" onclick="showView('clientes', this)">
                <span class="nav-icon">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                </span>Clientes
            </div>
            <div class="nav-link" data-view="reportes" onclick="showView('reportes', this)">
                <span class="nav-icon">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="20" x2="18" y2="10"/>
                        <line x1="12" y1="20" x2="12" y2="4"/>
                        <line x1="6" y1="20" x2="6" y2="14"/>
                    </svg>
                </span>Reportes
            </div>
        </div>
        <div class="nav-section">
            <div class="nav-label">Inteligencia Artificial</div>
            <a href="/chat" class="nav-link">
                <span class="nav-icon">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2Z"/>
                        <circle cx="9" cy="14" r="1"/>
                        <circle cx="15" cy="14" r="1"/>
                    </svg>
                </span>Asistente IA
            </a>
        </div>
    </div>

    <div class="main-content">
        <div class="topbar">
            <h1 class="page-title" id="pageTitle">Panel Principal</h1>
            <button class="logout-btn" onclick="cerrarSesion()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <polyline points="16 17 21 12 16 7"/>
                    <line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
                Cerrar Sesi√≥n
            </button>
        </div>
        
        <div class="content" id="mainContent"></div>
    </div>

    <div id="modalForm" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="modalTitle"></div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
let currentView = 'dashboard';
let data = { productos: [], clientes: [], ventas: [], alquileres: [], carrito: [], ventasOriginales: [], alquileresOriginales: [] };
let isInitialized = false;
let filtroActual = 'todos';
let clienteSeleccionado = null;
let productoSeleccionado = null;

async function request(url, options = {}) {
    try {
        const res = await fetch(url, { ...options, headers: { 'Content-Type': 'application/json', ...options.headers } });
        return await res.json();
    } catch (error) {
        console.error('Error en request:', error);
        return { success: false, error: error.message };
    }
}

async function showView(view, element) {
    currentView = view;
    
    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
    
    if (element) {
        element.classList.add('active');
    } else {
        const linkElement = document.querySelector(`[data-view="${view}"]`);
        if (linkElement) {
            linkElement.classList.add('active');
        }
    }
    
    const titles = { 
        dashboard: 'Panel Principal', 
        productos: 'Productos', 
        ventas: 'Ventas', 
        alquileres: 'Alquileres',
        clientes: 'Clientes', 
        reportes: 'Reportes'
    };
    document.getElementById('pageTitle').textContent = titles[view] || 'Panel Principal';
    
    if (view === 'dashboard') await renderDashboard();
    else if (view === 'productos') await renderProductos();
    else if (view === 'ventas') await renderVentas();
    else if (view === 'alquileres') await renderAlquileres();
    else if (view === 'clientes') await renderClientes();
    else if (view === 'reportes') await renderReportes();
}

async function renderDashboard() {
    const d = await request('/api/dashboard');
    
    // Separar productos con stock 0 y stock bajo
    const productosAgotados = d.productos_bajo_stock.filter(p => p.stock === 0);
    const productosStockBajo = d.productos_bajo_stock.filter(p => p.stock > 0);
    
    document.getElementById('mainContent').innerHTML = `
        <div class="stats-grid">
            <div class="stat-card blue">
                <div class="stat-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                    </svg>
                </div>
                <div class="stat-value">${d.total_productos}</div>
                <div class="stat-label">Productos</div>
            </div>
            <div class="stat-card green">
                <div class="stat-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                </div>
                <div class="stat-value">${d.total_clientes}</div>
                <div class="stat-label">Clientes</div>
            </div>
            <div class="stat-card orange">
                <div class="stat-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6v6l4 2"/>
                    </svg>
                </div>
                <div class="stat-value">${d.total_ventas}</div>
                <div class="stat-label">Ventas</div>
            </div>
            <div class="stat-card purple">
                <div class="stat-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        <polyline points="9 22 9 12 15 12 15 22"/>
                    </svg>
                </div>
                <div class="stat-value">${d.total_alquileres}</div>
                <div class="stat-label">Alquileres</div>
            </div>
            <div class="stat-card red">
                <div class="stat-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="1" x2="12" y2="23"/>
                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                    </svg>
                </div>
                <div class="stat-value">$ ${d.total_vendido_hoy.toFixed(2)}</div>
                <div class="stat-label">Vendido Hoy</div>
            </div>
        </div>
        
        ${productosAgotados.length > 0 ? `
            <div class="alert" style="background:#ffebee; color:#c62828; border-color:#d32f2f">
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#c62828" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    <strong style="font-size:16px">‚ö†Ô∏è PRODUCTOS AGOTADOS (${productosAgotados.length})</strong>
                </div>
                <div style="background:#fff; padding:15px; border-radius:8px; margin-top:10px">
                    ${productosAgotados.map(p => `
                        <div style="display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid #ffcdd2">
                            <div>
                                <strong style="color:#c62828">${p.nombre}</strong>
                                <span class="badge badge-danger" style="margin-left:8px">STOCK: 0</span>
                            </div>
                            <button class="btn btn-primary" style="padding:6px 12px; font-size:13px" onclick="showView('productos', document.querySelector('[data-view=productos]'))">
                                Reabastecer
                            </button>
                        </div>
                    `).join('')}
                </div>
            </div>
        ` : ''}
        
        ${productosStockBajo.length > 0 ? `
            <div class="alert alert-warning">
                <strong>‚ö†Ô∏è Stock bajo:</strong> ${productosStockBajo.map(p => `${p.nombre} (${p.stock})`).join(', ')}
            </div>
        ` : ''}
        
        <div class="grid-2">
            <div class="card">
                <h3>Ventas Recientes</h3>
                ${d.ventas_recientes.map(v => `<p>üõí ${v.cliente} - $ ${v.total.toFixed(2)} (${v.fecha})</p>`).join('') || '<p>No hay ventas</p>'}
            </div>
            <div class="card">
                <h3>Alquileres Recientes</h3>
                ${d.alquileres_recientes && d.alquileres_recientes.length > 0 ? d.alquileres_recientes.map(a => `
                    <p>üè† ${a.cliente} - $ ${a.total.toFixed(2)} 
                    <br><small style="color:#666">${a.fecha_inicio} ‚Üí ${a.fecha_fin} | <span class="badge ${a.estado === 'activo' ? 'badge-success' : 'badge-info'}">${a.estado}</span></small></p>
                `).join('') : '<p>No hay alquileres</p>'}
            </div>
        </div>
        <div class="card">
            <h3>Acceso R√°pido</h3>
            <div style="display:flex; gap:10px; flex-wrap:wrap">
                <button class="btn btn-primary" onclick="showView('ventas', document.querySelector('[data-view=ventas]')); setTimeout(() => mostrarFormVenta(), 100)">Nueva Venta</button>
                <button class="btn btn-warning" onclick="showView('alquileres', document.querySelector('[data-view=alquileres]')); setTimeout(() => mostrarFormAlquiler(), 100)">Nuevo Alquiler</button>
                <button class="btn btn-success" onclick="showView('productos', document.querySelector('[data-view=productos]')); setTimeout(() => mostrarFormProducto(), 100)">Nuevo Producto</button>
            </div>
        </div>
    `;
}

async function renderProductos() {
    data.productos = await request('/api/productos');
    console.log('Productos cargados:', data.productos);
    
    document.getElementById('mainContent').innerHTML = `
        <div class="card">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px">
                <input type="text" class="form-control" placeholder="Buscar..." onkeyup="filtrarProductos(this.value)" style="max-width:300px">
                <button class="btn btn-primary" onclick="mostrarFormProducto()">Nuevo Producto</button>
            </div>
            <div class="product-grid" id="productGrid">
                ${data.productos.map(p => {
                    const imagenUrl = p.imagen ? `/uploads/${p.imagen}` : null;
                    const tieneImagen = imagenUrl !== null;
                    
                    // Determinar estado del stock
                    const stockAgotado = p.stock === 0;
                    const stockBajo = p.stock > 0 && p.stock <= p.stock_minimo;
                    
                    let imagenHTML = '';
                    if (tieneImagen) {
                        imagenHTML = `<div class="product-image" style="background-image: url('${imagenUrl}'); background-size: cover; background-position: center; ${stockAgotado ? 'filter: grayscale(80%); opacity: 0.7;' : ''}"></div>`;
                    } else {
                        imagenHTML = `<div class="product-image" style="${stockAgotado ? 'filter: grayscale(80%); opacity: 0.7;' : ''}"></div>`;
                    }
                    
                    return `
                    <div class="product-card ${stockAgotado ? 'producto-agotado' : ''}">
                        ${stockAgotado ? '<span class="product-badge badge badge-danger" style="z-index:10">AGOTADO</span>' : 
                          stockBajo ? '<span class="product-badge badge badge-warning">STOCK BAJO</span>' : 
                          p.disponible_alquiler ? '<span class="product-badge badge badge-purple">Alquilable</span>' : ''}
                        ${imagenHTML}
                        <div class="product-info">
                            <div class="product-name" style="${stockAgotado ? 'color: #999;' : ''}">${p.nombre}</div>
                            <div class="product-price" style="${stockAgotado ? 'color: #999;' : ''}">üí∞ $ ${p.precio.toFixed(2)}</div>
                            ${p.disponible_alquiler ? `<p style="color:${stockAgotado ? '#999' : '#7b1fa2'}; font-size:13px">üè† $ ${p.precio_alquiler_dia.toFixed(2)}/d√≠a</p>` : ''}
                            <p style="color:#666; font-size:13px">üè¢ ${p.proveedor || 'No especificado'}</p>
                            <p style="color:${stockAgotado ? '#d32f2f' : stockBajo ? '#f57c00' : '#666'}; font-size:13px; font-weight:${stockAgotado ? '700' : '400'}">
                                üì¶ Stock: ${p.stock} ${stockAgotado ? '‚ö†Ô∏è AGOTADO' : stockBajo ? '‚ö†Ô∏è' : ''} | Min: ${p.stock_minimo}
                            </p>
                            <div style="display:flex; gap:10px; margin-top:10px">
                                <button class="btn btn-primary" style="flex:1; padding:8px" onclick='editarProducto(${JSON.stringify(p)})'>Editar</button>
                                <button class="btn btn-danger" style="flex:1; padding:8px" onclick="eliminarProducto(${p.id})">Eliminar</button>
                            </div>
                        </div>
                    </div>
                `}).join('')}
            </div>
        </div>
    `;
}

function filtrarProductos(txt) {
    const cards = document.querySelectorAll('.product-card');
    cards.forEach(c => c.style.display = c.textContent.toLowerCase().includes(txt.toLowerCase()) ? 'block' : 'none');
}

function mostrarFormProducto(producto = null) {
    const p = producto || { nombre: '', tipo: '', precio: '', precio_alquiler_dia: 0, disponible_alquiler: false, stock: '', stock_minimo: 5, proveedor: '', descripcion: '', imagen: '' };
    document.getElementById('modalTitle').textContent = producto ? 'Editar Producto' : 'Nuevo Producto';
    document.getElementById('modalBody').innerHTML = `
        <form id="formProducto" onsubmit="guardarProducto(event, ${producto ? producto.id : 'null'})">
            <div class="form-group"><label class="form-label">Nombre</label><input class="form-control" name="nombre" value="${p.nombre}" required></div>
            <div class="form-group"><label class="form-label">Tipo</label>
                <select class="form-control" name="tipo" required>
                    <option value="aretes" ${p.tipo==='aretes'?'selected':''}>Aretes</option>
                    <option value="collares" ${p.tipo==='collares'?'selected':''}>Collares</option>
                    <option value="coronas" ${p.tipo==='coronas'?'selected':''}>Coronas</option>
                    <option value="bisuteria" ${p.tipo==='bisuteria'?'selected':''}>Bisuter√≠a</option>
                </select>
            </div>
            <div class="form-group"><label class="form-label">Proveedor</label><input class="form-control" name="proveedor" value="${p.proveedor}" placeholder="Nombre del proveedor"></div>
            <div class="form-group">
                <label class="form-label">Imagen del Producto</label>
                <input type="file" class="form-control" id="imagenProducto" accept="image/*" onchange="previewImagen(event)">
                <div id="imagePreview" style="margin-top:10px; text-align:center">
                    ${p.imagen ? `<img src="/uploads/${p.imagen}" style="max-width:200px; max-height:200px; border-radius:8px">` : '<p style="color:#666; font-size:13px">No hay imagen seleccionada</p>'}
                </div>
            </div>
            <div class="grid-2">
                <div class="form-group"><label class="form-label">Precio Venta ($)</label><input type="number" step="0.01" class="form-control" name="precio" value="${p.precio}" required></div>
                <div class="form-group"><label class="form-label">Stock</label><input type="number" class="form-control" name="stock" value="${p.stock}" required></div>
            </div>
            <div class="form-group"><label class="form-label">Stock M√≠nimo</label><input type="number" class="form-control" name="stock_minimo" value="${p.stock_minimo}"></div>
            
            <div class="form-check">
                <input type="checkbox" id="disponible_alquiler" name="disponible_alquiler" ${p.disponible_alquiler ? 'checked' : ''} onchange="toggleAlquilerFields(this.checked)">
                <label for="disponible_alquiler" class="form-label" style="margin:0">üè† Disponible para alquiler</label>
            </div>
            
            <div id="alquilerFields" style="display:${p.disponible_alquiler ? 'block' : 'none'}; background:#f3e5f5; padding:15px; border-radius:8px; margin-top:10px">
                <div class="form-group"><label class="form-label">Precio por D√≠a ($)</label><input type="number" step="0.01" class="form-control" name="precio_alquiler_dia" value="${p.precio_alquiler_dia}"></div>
            </div>
            
            <div class="form-group"><label class="form-label">Descripci√≥n</label><textarea class="form-control" name="descripcion">${p.descripcion||''}</textarea></div>
            <div style="display:flex; gap:10px">
                <button type="submit" class="btn btn-primary" style="flex:1">Guardar</button>
                <button type="button" class="btn btn-danger" onclick="closeModal()">Cancelar</button>
            </div>
        </form>
    `;
    document.getElementById('modalForm').classList.add('active');
}

function toggleAlquilerFields(checked) {
    document.getElementById('alquilerFields').style.display = checked ? 'block' : 'none';
}

function previewImagen(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('imagePreview').innerHTML = `
                <img src="${e.target.result}" style="max-width:200px; max-height:200px; border-radius:8px">
                <p style="color:#2e7d32; font-size:13px; margin-top:5px">Imagen cargada: ${file.name}</p>
            `;
        };
        reader.readAsDataURL(file);
    }
}

function editarProducto(p) { mostrarFormProducto(p); }

async function guardarProducto(e, id) {
    e.preventDefault();
    const formElement = document.getElementById('formProducto');
    
    try {
        let response;
        
        if (id) {
            const formData = new FormData(formElement);
            const data = {
                id: id,
                nombre: formData.get('nombre'),
                tipo: formData.get('tipo'),
                precio: formData.get('precio'),
                precio_alquiler_dia: formData.get('precio_alquiler_dia') || 0,
                disponible_alquiler: document.getElementById('disponible_alquiler').checked,
                stock: formData.get('stock'),
                stock_minimo: formData.get('stock_minimo'),
                proveedor: formData.get('proveedor'),
                descripcion: formData.get('descripcion')
            };
            
            response = await fetch('/api/productos', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
        } else {
            const formData = new FormData();
            
            formData.append('nombre', formElement.querySelector('input[name="nombre"]').value);
            formData.append('tipo', formElement.querySelector('select[name="tipo"]').value);
            formData.append('precio', formElement.querySelector('input[name="precio"]').value);
            formData.append('precio_alquiler_dia', formElement.querySelector('input[name="precio_alquiler_dia"]').value || 0);
            formData.append('disponible_alquiler', document.getElementById('disponible_alquiler').checked);
            formData.append('stock', formElement.querySelector('input[name="stock"]').value);
            formData.append('stock_minimo', formElement.querySelector('input[name="stock_minimo"]').value);
            formData.append('proveedor', formElement.querySelector('input[name="proveedor"]').value);
            formData.append('descripcion', formElement.querySelector('textarea[name="descripcion"]').value);
            
            const imagenInput = document.getElementById('imagenProducto');
            if (imagenInput && imagenInput.files && imagenInput.files[0]) {
                formData.append('imagen', imagenInput.files[0]);
            }
            
            response = await fetch('/api/productos', {
                method: 'POST',
                body: formData
            });
        }
        
        const result = await response.json();
        
        if (result.success) {
            closeModal();
            await renderProductos();
            alert('Producto guardado correctamente');
        } else {
            alert('Error al guardar producto: ' + (result.error || 'Error desconocido'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al guardar producto: ' + error.message);
    }
}

async function eliminarProducto(id) {
    if (confirm('¬øEliminar producto?')) {
        await request('/api/productos', { method: 'DELETE', body: JSON.stringify({ id }) });
        renderProductos();
    }
}

async function renderClientes() {
    data.clientes = await request('/api/clientes');
    document.getElementById('mainContent').innerHTML = `
        <div class="card">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px">
                <h2>Clientes</h2>
                <button class="btn btn-primary" onclick="mostrarFormCliente()">Nuevo Cliente</button>
            </div>
            <table class="table">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Tel√©fono</th>
                        <th>Email</th>
                        <th>Compras</th>
                        <th>Alquileres</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.clientes.map(c => `
                        <tr>
                            <td><strong>${c.nombre}</strong></td>
                            <td>${c.telefono || '-'}</td>
                            <td>${c.email || '-'}</td>
                            <td>
                                <span class="badge badge-info">${c.total_compras}</span>
                            </td>
                            <td>
                                <span class="badge badge-purple">${c.total_alquileres}</span>
                            </td>
                            <td>
                                <div style="display:flex; gap:10px">
                                    <button class="btn btn-primary" 
                                            style="padding:6px 12px; font-size:13px" 
                                            onclick='editarCliente(${JSON.stringify(c)})'>
                                        Editar
                                    </button>
                                    <button class="btn btn-danger" 
                                            style="padding:6px 12px; font-size:13px; display:inline-flex; align-items:center; gap:5px" 
                                            onclick="eliminarCliente(${c.id}, '${c.nombre.replace(/'/g, "\\'")}', ${c.total_compras}, ${c.total_alquileres})">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="3 6 5 6 21 6"/>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                            <line x1="10" y1="11" x2="10" y2="17"/>
                                            <line x1="14" y1="11" x2="14" y2="17"/>
                                        </svg>
                                        Eliminar
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

// ==================== FUNCI√ìN PARA ELIMINAR CLIENTE ====================
async function eliminarCliente(id, nombre, totalCompras, totalAlquileres) {
    mostrarModalConfirmacion(id, nombre, totalCompras, totalAlquileres);
}

function mostrarModalConfirmacion(id, nombre, totalCompras, totalAlquileres) {
    document.getElementById('modalTitle').textContent = '‚ö†Ô∏è Confirmar Eliminaci√≥n';
    
    const tieneRegistros = totalCompras > 0 || totalAlquileres > 0;
    
    document.getElementById('modalBody').innerHTML = `
        <div style="padding:20px 0">
            <div style="background:#fff3e0; border-left:4px solid #f57c00; padding:20px; border-radius:8px; margin-bottom:20px">
                <div style="display:flex; align-items:center; gap:12px; margin-bottom:15px">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#f57c00" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    <h3 style="margin:0; color:#e65100">Advertencia de Eliminaci√≥n</h3>
                </div>
                
                <p style="font-size:15px; line-height:1.6; margin-bottom:15px">
                    Est√°s a punto de eliminar al cliente <strong>"${nombre}"</strong>.
                </p>
                
                ${tieneRegistros ? `
                    <div style="background:#ffebee; padding:15px; border-radius:6px; margin-top:15px">
                        <p style="margin:0 0 10px 0; font-weight:600; color:#c62828">
                            Esta acci√≥n tambi√©n eliminar√°:
                        </p>
                        <ul style="margin:0; padding-left:20px; color:#666">
                            ${totalCompras > 0 ? `<li><strong>${totalCompras}</strong> venta(s) registrada(s)</li>` : ''}
                            ${totalAlquileres > 0 ? `<li><strong>${totalAlquileres}</strong> alquiler(es) registrado(s)</li>` : ''}
                        </ul>
                        <p style="margin:15px 0 0 0; font-size:13px; color:#999; font-style:italic">
                            * El stock de los productos ser√° restaurado autom√°ticamente
                        </p>
                    </div>
                ` : `
                    <div style="background:#e8f5e9; padding:15px; border-radius:6px; margin-top:15px">
                        <p style="margin:0; color:#2e7d32; font-size:14px">
                            ‚úì Este cliente no tiene ventas ni alquileres registrados.
                        </p>
                    </div>
                `}
            </div>
            
            <p style="font-size:14px; color:#666; text-align:center; margin-top:20px">
                <strong style="color:#d32f2f">Esta acci√≥n no se puede deshacer.</strong>
            </p>
        </div>
        
        <div style="display:flex; gap:10px; margin-top:20px">
            <button class="btn btn-danger" style="flex:1; padding:12px; font-weight:600" onclick="confirmarEliminacionCliente(${id}, '${nombre.replace(/'/g, "\\'")}')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
                S√≠, Eliminar Cliente
            </button>
            <button class="btn btn-primary" style="flex:1; padding:12px" onclick="closeModal()">Cancelar</button>
        </div>
    `;
    
    document.getElementById('modalForm').classList.add('active');
}

async function confirmarEliminacionCliente(id, nombre) {
    try {
        const result = await request('/api/clientes', { 
            method: 'DELETE', 
            body: JSON.stringify({ id }) 
        });
        
        if (result.success) {
            closeModal();
            
            // Mostrar modal de √©xito
            document.getElementById('modalTitle').textContent = 'Eliminaci√≥n Exitosa';
            document.getElementById('modalBody').innerHTML = `
                <div style="text-align:center; padding:30px 20px">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#2e7d32" stroke-width="2" style="margin-bottom:20px">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M9 12l2 2 4-4"/>
                    </svg>
                    <h3 style="color:#2e7d32; margin-bottom:15px">Cliente eliminado correctamente</h3>
                    <p style="color:#666; margin-bottom:10px">
                        El cliente <strong>"${nombre}"</strong> ha sido eliminado.
                    </p>
                    ${result.ventas_eliminadas > 0 || result.alquileres_eliminados > 0 ? `
                        <div style="background:#f5f5f5; padding:15px; border-radius:8px; margin-top:15px">
                            <p style="margin:0; color:#666; font-size:14px">
                                Tambi√©n se eliminaron:
                            </p>
                            <ul style="list-style:none; padding:0; margin:10px 0 0 0">
                                ${result.ventas_eliminadas > 0 ? `<li>üõí ${result.ventas_eliminadas} venta(s)</li>` : ''}
                                ${result.alquileres_eliminados > 0 ? `<li>üè† ${result.alquileres_eliminados} alquiler(es)</li>` : ''}
                            </ul>
                        </div>
                    ` : ''}
                </div>
                <button class="btn btn-primary" style="width:100%; padding:12px" onclick="closeModal(); renderClientes()">Aceptar</button>
            `;
            document.getElementById('modalForm').classList.add('active');
        } else {
            alert('‚ùå Error al eliminar cliente: ' + (result.error || 'Error desconocido'));
        }
    } catch (error) {
        console.error('Error al eliminar cliente:', error);
        alert('‚ùå Error al eliminar cliente: ' + error.message);
    }
}

function mostrarFormCliente(cliente = null) {
    const c = cliente || { nombre: '', telefono: '', email: '', direccion: '' };
    document.getElementById('modalTitle').textContent = cliente ? 'Editar Cliente' : 'Nuevo Cliente';
    document.getElementById('modalBody').innerHTML = `
        <form onsubmit="guardarCliente(event, ${cliente ? cliente.id : 'null'})">
            <div class="form-group">
                <label class="form-label">Nombre <span style="color:red">*</span></label>
                <input class="form-control" name="nombre" id="nombreCliente" value="${c.nombre}" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Tel√©fono</label>
                <input 
                    type="tel" 
                    class="form-control" 
                    name="telefono" 
                    id="telefonoCliente" 
                    value="${c.telefono||''}"
                    placeholder="Ej: 9876543210"
                    maxlength="10"
                    oninput="validarTelefonoInput(this)"
                    onkeypress="return soloNumeros(event)"
                >
                <small id="telefonoError" style="color:#d32f2f; display:none; margin-top:5px; font-size:12px">
                    El tel√©fono debe tener 10 d√≠gitos
                </small>
                <small style="color:#666; font-size:12px; margin-top:5px; display:block">
                    Debe contener 10 d√≠gitos num√©ricos
                </small>
            </div>
            
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-control" name="email" id="emailCliente" value="${c.email||''}" placeholder="correo@ejemplo.com">
            </div>
            
            <div class="form-group">
                <label class="form-label">Direcci√≥n</label>
                <textarea class="form-control" name="direccion" id="direccionCliente" rows="3">${c.direccion||''}</textarea>
            </div>
            
            <div style="display:flex; gap:10px">
                <button type="submit" class="btn btn-primary" id="btnGuardarCliente" style="flex:1">Guardar</button>
                <button type="button" class="btn btn-danger" onclick="closeModal()">Cancelar</button>
            </div>
        </form>
    `;
    document.getElementById('modalForm').classList.add('active');
}

function editarCliente(c) { mostrarFormCliente(c); }

async function guardarCliente(e, id) {
    e.preventDefault();
    
    const telefono = document.getElementById('telefonoCliente').value;
    
    // Validar tel√©fono si se proporcion√≥
    if (telefono && telefono.length > 0) {
        if (telefono.length !== 10) {
            document.getElementById('telefonoError').style.display = 'block';
            document.getElementById('telefonoCliente').style.borderColor = '#d32f2f';
            document.getElementById('telefonoCliente').style.backgroundColor = '#ffebee';
            document.getElementById('telefonoCliente').focus();
            return;
        }
        
        // Verificar que solo contenga n√∫meros
        if (!/^\d+$/.test(telefono)) {
            alert('‚ùå El tel√©fono solo debe contener n√∫meros');
            document.getElementById('telefonoCliente').focus();
            return;
        }
    }
    
    const form = new FormData(e.target);
    const datos = Object.fromEntries(form);
    if (id) datos.id = id;
    
    const result = await request('/api/clientes', { 
        method: id ? 'PUT' : 'POST', 
        body: JSON.stringify(datos) 
    });
    
    if (result.success) {
        closeModal();
        
        // Mostrar modal de √©xito
        document.getElementById('modalTitle').textContent = '‚úÖ Cliente Guardado';
        document.getElementById('modalBody').innerHTML = `
            <div style="text-align:center; padding:30px 20px">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#2e7d32" stroke-width="2" style="margin-bottom:20px">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M9 12l2 2 4-4"/>
                </svg>
                <h3 style="color:#2e7d32; margin-bottom:15px">
                    ${id ? 'Cliente actualizado' : 'Cliente creado'} correctamente
                </h3>
                <p style="color:#666">
                    <strong>"${datos.nombre}"</strong> ha sido ${id ? 'actualizado' : 'registrado'} en el sistema.
                </p>
            </div>
            <button class="btn btn-primary" style="width:100%; padding:12px" onclick="closeModal(); renderClientes()">Aceptar</button>
        `;
        document.getElementById('modalForm').classList.add('active');
    } else {
        alert('‚ùå Error al guardar cliente: ' + (result.error || 'Error desconocido'));
    }
}

async function renderAlquileres() {
    data.alquileresOriginales = await request('/api/alquileres');
    clienteSeleccionado = null;
    filtroActual = 'todos';
    mostrarAlquileres(data.alquileresOriginales);
}

function mostrarAlquileres(alquileresData) {
    const estados = ['activo', 'finalizado'];
    const tipos = [...new Set(data.alquileresOriginales.flatMap(g => 
        g.alquileres.flatMap(a => a.productos.map(p => p.tipo))
    ))];
    
    document.getElementById('mainContent').innerHTML = `
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
                <h2>Alquileres por Cliente</h2>
                <button class="btn btn-warning" onclick="mostrarFormAlquiler()">Nuevo Alquiler</button>
            </div>
            
            <div id="alquileresContainer">
                ${alquileresData.length === 0 ? '<p style="text-align:center; padding:40px; color:#999">No hay alquileres registrados</p>' : 
                    alquileresData.map((grupo, index) => `
                    <div class="cliente-grupo">
                        <div class="cliente-header" onclick="toggleItems('alquiler', ${index})">
                            <div class="cliente-info">
                                <div>
                                    <div class="cliente-nombre">${grupo.cliente}</div>
                                    <div class="cliente-stats">
                                        <span><strong>${grupo.total_alquileres}</strong> alquileres</span>
                                        <span>Total: <strong>$ ${grupo.total_gastado.toFixed(2)}</strong></span>
                                    </div>
                                </div>
                            </div>
                            <div class="toggle-icon" id="toggle-alquiler-${index}">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"/>
                                </svg>
                            </div>
                        </div>
                        <div class="items-lista" id="alquiler-lista-${index}">
                            ${grupo.alquileres.map(alq => `
                                <div class="item">
                                    <div class="item-header">
                                        <span class="item-id">Alquiler #${alq.id}</span>
                                        <span class="item-total">$ ${alq.total.toFixed(2)}</span>
                                    </div>
                                    <div class="item-info">
                                        <span style="display:flex; align-items:center; gap:5px">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                                <line x1="16" y1="2" x2="16" y2="6"/>
                                                <line x1="8" y1="2" x2="8" y2="6"/>
                                                <line x1="3" y1="10" x2="21" y2="10"/>
                                            </svg>
                                            ${alq.fecha_inicio} ‚Üí ${alq.fecha_fin}
                                        </span>
                                        <span class="badge ${alq.estado === 'activo' ? 'badge-success' : 'badge-info'}">${alq.estado}</span>
                                        <span style="display:flex; align-items:center; gap:5px">
                                            üí∞ Dep√≥sito: $ ${alq.deposito.toFixed(2)}
                                        </span>
                                        <span style="display:flex; align-items:center; gap:5px">
                                            üí≥ ${alq.metodo_pago}
                                        </span>
                                    </div>
                                    ${alq.fecha_devolucion_real ? `<p style="color:#2e7d32; font-size:13px; margin-top:5px">‚úÖ Devuelto: ${alq.fecha_devolucion_real}</p>` : ''}
                                    ${alq.notas ? `<p style="color:#666; font-size:13px; margin-top:5px">üìù ${alq.notas}</p>` : ''}
                                    <div class="item-productos">
                                        <strong style="font-size:13px; color:#666">Productos:</strong>
                                        ${alq.productos.map(p => `
                                            <div class="producto-detalle">
                                                <div>
                                                    <strong>${p.nombre}</strong>
                                                    <span class="badge badge-info" style="margin-left:5px">${p.tipo}</span>
                                                    <br>
                                                    <small style="color:#666">${p.cantidad} x $ ${p.precio_dia.toFixed(2)}/d√≠a x ${p.dias} d√≠as</small>
                                                </div>
                                                <div><strong>$ ${p.subtotal.toFixed(2)}</strong></div>
                                            </div>
                                        `).join('')}
                                    </div>
                                    <div style="text-align:right; margin-top:10px; display:flex; gap:10px; justify-content:flex-end">
                                        ${alq.estado === 'activo' ? `
                                            <button class="btn btn-success" style="padding:6px 12px; font-size:13px" onclick="event.stopPropagation(); finalizarAlquiler(${alq.id})">
                                                Finalizar Alquiler
                                            </button>
                                        ` : ''}
                                        <button class="btn btn-danger" style="padding:6px 12px; font-size:13px" onclick="event.stopPropagation(); eliminarAlquiler(${alq.id})">
                                            Eliminar
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    
    setTimeout(() => expandirTodosLosGrupos('alquiler'), 100);
}

async function finalizarAlquiler(id) {
    if (!confirm('¬øFinalizar este alquiler? El stock de los productos ser√° restaurado.')) return;
    
    const result = await request('/api/alquileres', { 
        method: 'PUT', 
        body: JSON.stringify({ id, accion: 'finalizar' }) 
    });
    
    if (result.success) {
        alert('Alquiler finalizado correctamente');
        await renderAlquileres();
    } else {
        alert('Error: ' + result.error);
    }
}

async function eliminarAlquiler(id) {
    if (!confirm('¬øEliminar este alquiler? El stock ser√° restaurado.')) return;
    
    const result = await request('/api/alquileres', { 
        method: 'DELETE', 
        body: JSON.stringify({ id }) 
    });
    
    if (result.success) {
        alert('Alquiler eliminado correctamente');
        await renderAlquileres();
    } else {
        alert('Error: ' + result.error);
    }
}

async function mostrarFormAlquiler() {
    data.productos = await request('/api/productos');
    data.clientes = await request('/api/clientes');
    data.carrito = [];
    productoSeleccionado = null;
    
    const productosAlquilables = data.productos.filter(p => p.disponible_alquiler && p.stock > 0);
    
    let dropdownHTML = '';
    if (productosAlquilables.length === 0) {
        dropdownHTML = '<div class="no-products-message">No hay productos alquilables con stock</div>';
    } else {
        dropdownHTML = productosAlquilables.map(p => {
            const stockClass = p.stock <= p.stock_minimo ? 'low' : '';
            return `
                <div class="custom-dropdown-item" onclick="seleccionarProductoDropdown(${p.id}, '${p.nombre.replace(/'/g, "\\'")}')">
                    <span class="product-item-name">${p.nombre}</span>
                    <div class="product-item-details">
                        <span class="product-item-price">$ ${p.precio_alquiler_dia.toFixed(2)}/d√≠a</span>
                        <span class="product-item-stock ${stockClass}">Stock: ${p.stock}</span>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    const hoy = new Date().toISOString().split('T')[0];
    const manana = new Date(Date.now() + 86400000).toISOString().split('T')[0];
    
    document.getElementById('modalTitle').textContent = 'Nuevo Alquiler';
    document.getElementById('modalBody').innerHTML = `
        <div class="form-group">
            <label class="form-label">Cliente</label>
            <select class="form-control" id="alquilerCliente" required>
                <option value="">Seleccione...</option>
                ${data.clientes.map(c => `<option value="${c.id}">${c.nombre}</option>`).join('')}
            </select>
        </div>
        <div class="grid-2">
            <div class="form-group">
                <label class="form-label">Fecha Inicio</label>
                <input type="date" class="form-control" id="fechaInicio" value="${hoy}" required>
            </div>
            <div class="form-group">
                <label class="form-label">Fecha Fin</label>
                <input type="date" class="form-control" id="fechaFin" value="${manana}" required>
            </div>
        </div>
        <div class="grid-2">
            <div class="form-group">
                <label class="form-label">M√©todo de Pago</label>
                <select class="form-control" id="alquilerPago" required>
                    <option value="Efectivo">Efectivo</option>
                    <option value="Tarjeta">Tarjeta</option>
                    <option value="Transferencia">Transferencia</option>
                    <option value="Yape/Plin">Yape/Plin</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Dep√≥sito ($)</label>
                <input type="number" step="0.01" class="form-control" id="deposito" value="0" required>
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">Notas (opcional)</label>
            <textarea class="form-control" id="notas" rows="2"></textarea>
        </div>
        <div class="form-group">
            <label class="form-label">Producto</label>
            <div class="custom-dropdown">
                <button type="button" class="custom-dropdown-button" onclick="toggleCustomDropdown('dropdownProductosAlq')">
                    <span class="placeholder">Seleccione un producto...</span>
                    <span class="arrow"></span>
                </button>
                <div class="custom-dropdown-menu" id="dropdownProductosAlq">
                    ${productosAlquilables.length > 5 ? `
                        <div class="custom-dropdown-search">
                            <input type="text" placeholder="Buscar producto..." onkeyup="filtrarProductosDropdown(this)" onclick="event.stopPropagation()">
                        </div>
                    ` : ''}
                    ${dropdownHTML}
                </div>
            </div>
            <button type="button" class="btn btn-black" style="margin-top:10px; width:100%" onclick="agregarAlCarritoAlquiler()">Agregar al Carrito</button>
        </div>
        <div id="carritoAlquiler"></div>
        <div style="margin-top:20px; padding:15px; background:#f3e5f5; border-radius:8px">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px">
                <span>D√≠as: <span id="diasAlquiler">1</span></span>
                <span>Subtotal: $ <span id="subtotalAlquiler">0.00</span></span>
            </div>
            <div style="display:flex; justify-content:space-between; margin-bottom:5px">
                <span>Dep√≥sito:</span>
                <span>$ <span id="depositoMostrar">0.00</span></span>
            </div>
            <div style="display:flex; justify-content:space-between; font-size:18px; font-weight:700; border-top:2px solid #7b1fa2; padding-top:10px">
                <span>Total:</span>
                <span>$ <span id="totalAlquiler">0.00</span></span>
            </div>
        </div>
        <div style="display:flex; gap:10px; margin-top:20px">
            <button class="btn btn-warning" style="flex:1" onclick="procesarAlquiler()">Procesar Alquiler</button>
            <button class="btn btn-danger" onclick="closeModal()">Cancelar</button>
        </div>
    `;
    document.getElementById('modalForm').classList.add('active');
    
    document.getElementById('fechaInicio').addEventListener('change', actualizarDiasAlquiler);
    document.getElementById('fechaFin').addEventListener('change', actualizarDiasAlquiler);
    document.getElementById('deposito').addEventListener('input', actualizarCarritoAlquiler);
}

function actualizarDiasAlquiler() {
    const inicio = new Date(document.getElementById('fechaInicio').value);
    const fin = new Date(document.getElementById('fechaFin').value);
    const dias = Math.ceil((fin - inicio) / (1000 * 60 * 60 * 24));
    document.getElementById('diasAlquiler').textContent = dias > 0 ? dias : 0;
    actualizarCarritoAlquiler();
}

function agregarAlCarritoAlquiler() {
    if (!productoSeleccionado) {
        alert('Seleccione un producto');
        return;
    }
    
    const prod = data.productos.find(p => p.id === productoSeleccionado);
    if (!prod) {
        alert('Producto no encontrado');
        return;
    }
    
    if (!prod.disponible_alquiler) {
        alert('Este producto no est√° disponible para alquiler');
        return;
    }
    
    const existe = data.carrito.find(c => c.producto_id === productoSeleccionado);
    
    if (existe) {
        if (existe.cantidad < prod.stock) {
            existe.cantidad++;
        } else {
            alert('Stock insuficiente');
            return;
        }
    } else {
        data.carrito.push({ 
            producto_id: productoSeleccionado, 
            nombre: prod.nombre, 
            precio_dia: prod.precio_alquiler_dia, 
            cantidad: 1, 
            stock: prod.stock 
        });
    }
    
    actualizarCarritoAlquiler();
    
    const button = document.querySelector('.custom-dropdown-button');
    button.innerHTML = `
        <span class="placeholder">Seleccione un producto...</span>
        <span class="arrow"></span>
    `;
    productoSeleccionado = null;
}

function actualizarCarritoAlquiler() {
    const inicio = new Date(document.getElementById('fechaInicio').value);
    const fin = new Date(document.getElementById('fechaFin').value);
    const dias = Math.max(1, Math.ceil((fin - inicio) / (1000 * 60 * 60 * 24)));
    
    const deposito = parseFloat(document.getElementById('deposito').value) || 0;
    const subtotal = data.carrito.reduce((sum, item) => sum + (item.precio_dia * item.cantidad * dias), 0);
    const total = subtotal + deposito;
    
    document.getElementById('diasAlquiler').textContent = dias;
    document.getElementById('subtotalAlquiler').textContent = subtotal.toFixed(2);
    document.getElementById('depositoMostrar').textContent = deposito.toFixed(2);
    document.getElementById('totalAlquiler').textContent = total.toFixed(2);
    
    document.getElementById('carritoAlquiler').innerHTML = `
        <h4 style="margin:15px 0">Carrito:</h4>
        ${data.carrito.map((item, i) => `
            <div style="background:#f5f5f5; padding:10px; border-radius:8px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center">
                <div>
                    <strong>${item.nombre}</strong><br>
                    $ ${item.precio_dia.toFixed(2)}/d√≠a x ${item.cantidad} x ${dias} d√≠as = $ ${(item.precio_dia * item.cantidad * dias).toFixed(2)}
                </div>
                <div>
                    <button class="btn btn-danger" style="padding:5px 10px" onclick="data.carrito.splice(${i}, 1); actualizarCarritoAlquiler()">Eliminar</button>
                </div>
            </div>
        `).join('')}
    `;
}

async function procesarAlquiler() {
    const cliente_id = parseInt(document.getElementById('alquilerCliente').value);
    const fecha_inicio = document.getElementById('fechaInicio').value;
    const fecha_fin = document.getElementById('fechaFin').value;
    const metodo_pago = document.getElementById('alquilerPago').value;
    const deposito = parseFloat(document.getElementById('deposito').value) || 0;
    const notas = document.getElementById('notas').value;
    
    if (!cliente_id) {
        alert('Seleccione un cliente');
        return;
    }
    if (data.carrito.length === 0) {
        alert('Agregue productos al carrito');
        return;
    }
    if (!fecha_inicio || !fecha_fin) {
        alert('Especifique las fechas de alquiler');
        return;
    }
    
    const result = await request('/api/alquileres', {
        method: 'POST',
        body: JSON.stringify({ 
            cliente_id, 
            fecha_inicio, 
            fecha_fin, 
            metodo_pago, 
            deposito,
            notas,
            productos: data.carrito 
        })
    });
    
    if (result.success) {
        alert('Alquiler registrado correctamente');
        closeModal();
        await renderAlquileres();
    } else {
        alert('Error: ' + result.error);
    }
}

async function renderVentas() {
    data.ventasOriginales = await request('/api/ventas');
    clienteSeleccionado = null;
    filtroActual = 'todos';
    aplicarFiltro('todos');
}

function aplicarFiltro(filtro, esSeleccionCliente = false) {
    if (esSeleccionCliente && filtro.startsWith('cliente_')) {
        const clienteId = parseInt(filtro.replace('cliente_', ''));
        clienteSeleccionado = clienteId;
        filtroActual = 'todos';
    } else if (filtro.startsWith('cliente_')) {
        const clienteId = parseInt(filtro.replace('cliente_', ''));
        clienteSeleccionado = clienteId;
        filtroActual = 'todos';
    } else {
        filtroActual = filtro;
    }
    
    let ventasFiltradas = JSON.parse(JSON.stringify(data.ventasOriginales));
    
    document.querySelectorAll('.dropdown-content').forEach(dropdown => {
        dropdown.classList.remove('show');
    });
    
    if (clienteSeleccionado !== null) {
        ventasFiltradas = ventasFiltradas.filter(grupo => grupo.cliente_id === clienteSeleccionado);
    }
    
    if (filtroActual === 'todos') {
        ventasFiltradas = ventasFiltradas;
    } else if (filtroActual === 'mas_recientes') {
        ventasFiltradas = ventasFiltradas.map(grupo => {
            const ventasOrdenadas = [...grupo.ventas].sort((a, b) => b.fecha_timestamp - a.fecha_timestamp);
            return {
                ...grupo,
                ventas: ventasOrdenadas.slice(0, 3)
            };
        });
    } else if (filtroActual === 'ultima_venta') {
        ventasFiltradas = ventasFiltradas.map(grupo => {
            const ventasOrdenadas = [...grupo.ventas].sort((a, b) => b.fecha_timestamp - a.fecha_timestamp);
            return {
                ...grupo,
                ventas: [ventasOrdenadas[0]]
            };
        });
    } else if (filtroActual.startsWith('tipo_')) {
        const tipo = filtroActual.replace('tipo_', '');
        ventasFiltradas = ventasFiltradas.map(grupo => {
            const ventasConTipo = grupo.ventas.filter(venta => 
                venta.productos.some(p => p.tipo === tipo)
            );
            return {
                ...grupo,
                ventas: ventasConTipo
            };
        }).filter(grupo => grupo.ventas.length > 0);
    }
    
    mostrarVentas(ventasFiltradas);
    
    if (!(clienteSeleccionado !== null && filtroActual === 'todos' && esSeleccionCliente)) {
        setTimeout(() => {
            expandirTodosLosGrupos('venta');
        }, 100);
    }
}

function limpiarFiltroCliente() {
    clienteSeleccionado = null;
    aplicarFiltro('todos');
}

function expandirTodosLosGrupos(tipo) {
    const todosLosGrupos = document.querySelectorAll('.items-lista');
    const todosLosIconos = document.querySelectorAll('.toggle-icon');
    
    todosLosGrupos.forEach(grupo => {
        grupo.classList.add('show');
    });
    
    todosLosIconos.forEach(icono => {
        icono.classList.add('rotated');
    });
}

function toggleDropdown(id, event) {
    if (event) {
        event.stopPropagation();
    }
    
    document.querySelectorAll('.dropdown-content').forEach(dropdown => {
        if (dropdown.id !== id) {
            dropdown.classList.remove('show');
        }
    });
    
    const dropdown = document.getElementById(id);
    if (dropdown) {
        dropdown.classList.toggle('show');
    }
}

document.addEventListener('click', function(event) {
    if (!event.target.closest('.dropdown')) {
        document.querySelectorAll('.dropdown-content').forEach(dropdown => {
            dropdown.classList.remove('show');
        });
    }
});

function toggleItems(tipo, index) {
    const itemsLista = document.getElementById(`${tipo}-lista-${index}`);
    const toggleIcon = document.getElementById(`toggle-${tipo}-${index}`);
    
    if (itemsLista && toggleIcon) {
        itemsLista.classList.toggle('show');
        toggleIcon.classList.toggle('rotated');
    }
}

function mostrarVentas(ventasData) {
    const tipos = [...new Set(data.ventasOriginales.flatMap(g => 
        g.ventas.flatMap(v => v.productos.map(p => p.tipo))
    ))];
    
    const getFiltroActualText = () => {
        let textos = [];
        
        if (clienteSeleccionado !== null) {
            const grupo = data.ventasOriginales.find(g => g.cliente_id === clienteSeleccionado);
            if (grupo) {
                textos.push(`Cliente: ${grupo.cliente}`);
            }
        }
        
        if (filtroActual === 'todos') {
            textos.push('Todas las ventas');
        } else if (filtroActual === 'mas_recientes') {
            textos.push('3 m√°s recientes');
        } else if (filtroActual === 'ultima_venta') {
            textos.push('√öltima venta');
        } else if (filtroActual.startsWith('tipo_')) {
            const tipo = filtroActual.replace('tipo_', '');
            textos.push(tipo.charAt(0).toUpperCase() + tipo.slice(1));
        }
        
        return textos.join(' ‚Üí ');
    };
    
    document.getElementById('mainContent').innerHTML = `
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
                <h2>Ventas por Cliente</h2>
                <button class="btn btn-primary" onclick="mostrarFormVenta()">Nueva Venta</button>
            </div>
            
            <div class="filtros-container">
                <div class="dropdown">
                    <button class="dropdown-btn" onclick="toggleDropdown('dropdownGeneral', event)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="4" y1="6" x2="20" y2="6"/>
                            <line x1="4" y1="12" x2="20" y2="12"/>
                            <line x1="4" y1="18" x2="20" y2="18"/>
                        </svg>
                        Filtros Generales
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                    </button>
                    <div class="dropdown-content" id="dropdownGeneral">
                        <div class="dropdown-item ${filtroActual === 'todos' && clienteSeleccionado === null ? 'active' : ''}" onclick="aplicarFiltro('todos', false)">Todas las ventas</div>
                        <div class="dropdown-item ${filtroActual === 'mas_recientes' ? 'active' : ''}" onclick="aplicarFiltro('mas_recientes', false)">3 m√°s recientes</div>
                        <div class="dropdown-item ${filtroActual === 'ultima_venta' ? 'active' : ''}" onclick="aplicarFiltro('ultima_venta', false)">√öltima venta</div>
                    </div>
                </div>
                
                <div class="dropdown">
                    <button class="dropdown-btn" onclick="toggleDropdown('dropdownTipos', event)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                        </svg>
                        Por Tipo de Producto
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                    </button>
                    <div class="dropdown-content" id="dropdownTipos">
                        ${tipos.map(tipo => `
                            <div class="dropdown-item ${filtroActual === 'tipo_'+tipo ? 'active' : ''}" onclick="aplicarFiltro('tipo_${tipo}', false)">
                                ${tipo.charAt(0).toUpperCase() + tipo.slice(1)}
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="dropdown">
                    <button class="dropdown-btn ${clienteSeleccionado !== null ? 'active' : ''}" onclick="toggleDropdown('dropdownClientes', event)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                        Por Cliente
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                    </button>
                    <div class="dropdown-content" id="dropdownClientes">
                        ${data.ventasOriginales.map(grupo => `
                            <div class="dropdown-item ${clienteSeleccionado === grupo.cliente_id ? 'active' : ''}" onclick="aplicarFiltro('cliente_${grupo.cliente_id}', true)">
                                ${grupo.cliente}
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                ${clienteSeleccionado !== null ? `
                    <button class="btn btn-danger" style="padding:8px 16px; font-size:13px; display:inline-flex; align-items:center; gap:5px" onclick="limpiarFiltroCliente()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                        Limpiar Cliente
                    </button>
                ` : ''}
                
                <div style="margin-left:auto; padding:10px 15px; background:#f5f5f5; border-radius:8px; font-weight:500">
                    Mostrando: <strong>${getFiltroActualText()}</strong>
                </div>
            </div>
            
            <div id="ventasContainer">
                ${ventasData.length === 0 ? '<p style="text-align:center; padding:40px; color:#999">No hay ventas con este filtro</p>' : 
                    ventasData.map((grupo, index) => `
                    <div class="cliente-grupo">
                        <div class="cliente-header" onclick="toggleItems('venta', ${index})">
                            <div class="cliente-info">
                                <div>
                                    <div class="cliente-nombre">${grupo.cliente}</div>
                                    <div class="cliente-stats">
                                        <span><strong>${grupo.total_compras}</strong> compras</span>
                                        <span>Total gastado: <strong>$ ${grupo.total_gastado.toFixed(2)}</strong></span>
                                    </div>
                                </div>
                            </div>
                            <div class="toggle-icon" id="toggle-venta-${index}">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"/>
                                </svg>
                            </div>
                        </div>
                        <div class="items-lista" id="venta-lista-${index}">
                            ${grupo.ventas.map(venta => `
                                <div class="item">
                                    <div class="item-header">
                                        <span class="item-id">Venta #${venta.id}</span>
                                        <span class="item-total">$ ${venta.total.toFixed(2)}</span>
                                    </div>
                                    <div class="item-info">
                                        <span style="display:flex; align-items:center; gap:5px">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                                <line x1="16" y1="2" x2="16" y2="6"/>
                                                <line x1="8" y1="2" x2="8" y2="6"/>
                                                <line x1="3" y1="10" x2="21" y2="10"/>
                                            </svg>
                                            ${venta.fecha}
                                        </span>
                                        <span style="display:flex; align-items:center; gap:5px">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                                                <line x1="1" y1="10" x2="23" y2="10"/>
                                            </svg>
                                            ${venta.metodo_pago}
                                        </span>
                                        <span style="display:flex; align-items:center; gap:5px">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                                            </svg>
                                            ${venta.cantidad_productos} producto(s)
                                        </span>
                                    </div>
                                    <div class="item-productos">
                                        <strong style="font-size:13px; color:#666">Productos:</strong>
                                        ${venta.productos.map(p => `
                                            <div class="producto-detalle">
                                                <div>
                                                    <strong>${p.nombre}</strong>
                                                    <span class="badge badge-info" style="margin-left:5px">${p.tipo}</span>
                                                    <br>
                                                    <small style="color:#666">${p.cantidad} x $ ${p.precio.toFixed(2)}</small>
                                                </div>
                                                <div><strong>$ ${p.subtotal.toFixed(2)}</strong></div>
                                            </div>
                                        `).join('')}
                                    </div>
                                    <div style="text-align:right; margin-top:10px">
                                        <button class="btn btn-danger" style="padding:6px 12px; font-size:13px; display:inline-flex; align-items:center; gap:5px" onclick="event.stopPropagation(); eliminarVenta(${venta.id})">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polyline points="3 6 5 6 21 6"/>
                                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                                <line x1="10" y1="11" x2="10" y2="17"/>
                                                <line x1="14" y1="11" x2="14" y2="17"/>
                                            </svg>
                                            Eliminar Venta
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

async function eliminarVenta(id) {
    if (!confirm('¬øEst√°s seguro de eliminar esta venta? El stock de los productos ser√° restaurado.')) return;
    
    const result = await request('/api/ventas', { 
        method: 'DELETE', 
        body: JSON.stringify({ id }) 
    });
    
    if (result.success) {
        alert('Venta eliminada correctamente');
        data.ventasOriginales = await request('/api/ventas');
        const clienteTemp = clienteSeleccionado;
        const filtroTemp = filtroActual;
        aplicarFiltro(filtroTemp, false);
        clienteSeleccionado = clienteTemp;
        aplicarFiltro(filtroTemp, false);
    } else {
        alert('Error al eliminar venta: ' + result.error);
    }
}

function toggleCustomDropdown(dropdownId) {
    const menu = document.getElementById(dropdownId);
    const button = menu.previousElementSibling;
    
    document.querySelectorAll('.custom-dropdown-menu').forEach(m => {
        if (m.id !== dropdownId) {
            m.classList.remove('show');
            m.previousElementSibling.classList.remove('active');
        }
    });
    
    menu.classList.toggle('show');
    button.classList.toggle('active');
}

function filtrarProductosDropdown(input) {
    const searchText = input.value.toLowerCase();
    const items = document.querySelectorAll('.custom-dropdown-item');
    
    items.forEach(item => {
        const text = item.textContent.toLowerCase();
        if (text.includes(searchText)) {
            item.style.display = 'flex';
        } else {
            item.style.display = 'none';
        }
    });
}

function seleccionarProductoDropdown(productoId, productoNombre) {
    const button = document.querySelector('.custom-dropdown-button');
    const menu = document.querySelectorAll('.custom-dropdown-menu')[0];
    
    button.innerHTML = `
        <span class="selected-text">${productoNombre}</span>
        <span class="arrow"></span>
    `;
    
    productoSeleccionado = productoId;
    
    menu.classList.remove('show');
    button.classList.remove('active');
    
    const searchInput = document.querySelector('.custom-dropdown-search input');
    if (searchInput) {
        searchInput.value = '';
        filtrarProductosDropdown(searchInput);
    }
}

document.addEventListener('click', function(event) {
    if (!event.target.closest('.custom-dropdown')) {
        document.querySelectorAll('.custom-dropdown-menu').forEach(menu => {
            menu.classList.remove('show');
            if (menu.previousElementSibling) {
                menu.previousElementSibling.classList.remove('active');
            }
        });
    }
});

async function mostrarFormVenta() {
    data.productos = await request('/api/productos');
    data.clientes = await request('/api/clientes');
    data.carrito = [];
    productoSeleccionado = null;
    
    const productosDisponibles = data.productos.filter(p => p.stock > 0);
    
    let dropdownHTML = '';
    if (productosDisponibles.length === 0) {
        dropdownHTML = '<div class="no-products-message">No hay productos disponibles con stock</div>';
    } else {
        dropdownHTML = productosDisponibles.map(p => {
            const stockClass = p.stock <= p.stock_minimo ? 'low' : '';
            return `
                <div class="custom-dropdown-item" onclick="seleccionarProductoDropdown(${p.id}, '${p.nombre.replace(/'/g, "\\'")}')">
                    <span class="product-item-name">${p.nombre}</span>
                    <div class="product-item-details">
                        <span class="product-item-price">$ ${p.precio.toFixed(2)}</span>
                        <span class="product-item-stock ${stockClass}">Stock: ${p.stock}</span>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    document.getElementById('modalTitle').textContent = 'Nueva Venta';
    document.getElementById('modalBody').innerHTML = `
        <div class="form-group">
            <label class="form-label">Cliente</label>
            <select class="form-control" id="ventaCliente" required>
                <option value="">Seleccione...</option>
                ${data.clientes.map(c => `<option value="${c.id}">${c.nombre}</option>`).join('')}
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">M√©todo de Pago</label>
            <select class="form-control" id="ventaPago" required>
                <option value="Efectivo">Efectivo</option>
                <option value="Tarjeta">Tarjeta</option>
                <option value="Transferencia">Transferencia</option>
                <option value="Yape/Plin">Yape/Plin</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Producto</label>
            <div class="custom-dropdown">
                <button type="button" class="custom-dropdown-button" onclick="toggleCustomDropdown('dropdownProductos')">
                    <span class="placeholder">Seleccione un producto...</span>
                    <span class="arrow"></span>
                </button>
                <div class="custom-dropdown-menu" id="dropdownProductos">
                    ${productosDisponibles.length > 5 ? `
                        <div class="custom-dropdown-search">
                            <input type="text" placeholder="Buscar producto..." onkeyup="filtrarProductosDropdown(this)" onclick="event.stopPropagation()">
                        </div>
                    ` : ''}
                    ${dropdownHTML}
                </div>
            </div>
            <button type="button" class="btn btn-black" style="margin-top:10px; width:100%" onclick="agregarAlCarrito()">Agregar al Carrito</button>
        </div>
        <div id="carritoVenta"></div>
        <div style="margin-top:20px; padding:15px; background:#f5f5f5; border-radius:8px">
            <h3>Total: $ <span id="totalVenta">0.00</span></h3>
        </div>
        <div style="display:flex; gap:10px; margin-top:20px">
            <button class="btn btn-primary" style="flex:1" onclick="procesarVenta()">Procesar Venta</button>
            <button class="btn btn-danger" onclick="closeModal()">Cancelar</button>
        </div>
    `;
    document.getElementById('modalForm').classList.add('active');
}

function agregarAlCarrito() {
    if (!productoSeleccionado) {
        alert('Seleccione un producto');
        return;
    }
    
    const prod = data.productos.find(p => p.id === productoSeleccionado);
    if (!prod) {
        alert('Producto no encontrado');
        return;
    }
    
    const existe = data.carrito.find(c => c.producto_id === productoSeleccionado);
    
    if (existe) {
        if (existe.cantidad < prod.stock) {
            existe.cantidad++;
        } else {
            alert('Stock insuficiente');
            return;
        }
    } else {
        data.carrito.push({ 
            producto_id: productoSeleccionado, 
            nombre: prod.nombre, 
            precio: prod.precio, 
            cantidad: 1, 
            stock: prod.stock 
        });
    }
    
    actualizarCarrito();
    
    const button = document.querySelector('.custom-dropdown-button');
    button.innerHTML = `
        <span class="placeholder">Seleccione un producto...</span>
        <span class="arrow"></span>
    `;
    productoSeleccionado = null;
}

function actualizarCarrito() {
    const total = data.carrito.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
    document.getElementById('totalVenta').textContent = total.toFixed(2);
    document.getElementById('carritoVenta').innerHTML = `
        <h4 style="margin:15px 0">Carrito:</h4>
        ${data.carrito.map((item, i) => `
            <div style="background:#f5f5f5; padding:10px; border-radius:8px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center">
                <div>
                    <strong>${item.nombre}</strong><br>
                    $ ${item.precio.toFixed(2)} x ${item.cantidad} = $ ${(item.precio * item.cantidad).toFixed(2)}
                </div>
                <div>
                    <button class="btn btn-danger" style="padding:5px 10px" onclick="data.carrito.splice(${i}, 1); actualizarCarrito()">Eliminar</button>
                </div>
            </div>
        `).join('')}
    `;
}

async function procesarVenta() {
    const cliente_id = parseInt(document.getElementById('ventaCliente').value);
    const metodo_pago = document.getElementById('ventaPago').value;
    
    if (!cliente_id) {
        alert('Seleccione un cliente');
        return;
    }
    if (data.carrito.length === 0) {
        alert('Agregue productos al carrito');
        return;
    }
    
    const result = await request('/api/ventas', {
        method: 'POST',
        body: JSON.stringify({ cliente_id, metodo_pago, productos: data.carrito })
    });
    
    if (result.success) {
        alert('Venta registrada correctamente');
        closeModal();
        data.ventasOriginales = await request('/api/ventas');
        const clienteTemp = clienteSeleccionado;
        const filtroTemp = filtroActual;
        aplicarFiltro(filtroTemp, false);
        clienteSeleccionado = clienteTemp;
        aplicarFiltro(filtroTemp, false);
    } else {
        alert('Error: ' + result.error);
    }
}

async function renderReportes() {
    const r = await request('/api/reportes');
    
    const reportesHistoricos = await request('/api/reportes/historicos');
    
    const fechaActual = new Date();
    const mesActual = fechaActual.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
    
    document.getElementById('mainContent').innerHTML = `
        <div class="stats-grid">
            <div class="stat-card blue">
                <div class="stat-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6v6l4 2"/>
                    </svg>
                </div>
                <div class="stat-value">${r.total_ventas}</div>
                <div class="stat-label">Total Ventas</div>
            </div>
            <div class="stat-card green">
                <div class="stat-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="1" x2="12" y2="23"/>
                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                    </svg>
                </div>
                <div class="stat-value">$ ${r.total_ingresos.toFixed(2)}</div>
                <div class="stat-label">Ingresos Ventas</div>
            </div>
            <div class="stat-card purple">
                <div class="stat-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        <polyline points="9 22 9 12 15 12 15 22"/>
                    </svg>
                </div>
                <div class="stat-value">${r.total_alquileres}</div>
                <div class="stat-label">Total Alquileres</div>
            </div>
            <div class="stat-card orange">
                <div class="stat-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="1" x2="12" y2="23"/>
                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                    </svg>
                </div>
                <div class="stat-value">$ ${r.ingresos_alquileres.toFixed(2)}</div>
                <div class="stat-label">Ingresos Alquileres</div>
            </div>
            <div class="stat-card red">
                <div class="stat-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                    </svg>
                </div>
                <div class="stat-value">${r.alquileres_activos}</div>
                <div class="stat-label">Alquileres Activos</div>
            </div>
        </div>
        
        <div class="card" style="margin-bottom:20px">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
                <h3 style="margin:0">Reporte del Mes: ${mesActual}</h3>
                <button class="btn btn-black" onclick="generarReporteMensual()" style="display:inline-flex; align-items:center; gap:8px">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Generar y Guardar Reporte
                </button>
            </div>
            
            <div class="grid-2">
                <div style="background:#f9f9f9; padding:20px; border-radius:8px">
                    <h4 style="margin-bottom:15px; display:flex; align-items:center; gap:8px">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                        </svg>
                        Productos M√°s Vendidos
                    </h4>
                    ${r.productos_mas_vendidos.length > 0 ? r.productos_mas_vendidos.map((p, i) => `
                        <div style="display:flex; justify-content:space-between; align-items:center; padding:12px; background:white; border-radius:6px; margin-bottom:8px; border-left:3px solid ${i === 0 ? '#2e7d32' : i === 1 ? '#1976d2' : '#666'}">
                            <div>
                                <span><strong>${i + 1}.</strong> ${p.nombre}</span>
                                <br>
                                <small style="color:#999">üì¶ ${p.tipo} | üè¢ ${p.proveedor || 'No especificado'}</small>
                            </div>
                            <span class="badge badge-success">${p.cantidad} unidades</span>
                        </div>
                    `).join('') : '<p style="text-align:center; color:#999">No hay datos</p>'}
                </div>
                
                <div style="background:#f9f9f9; padding:20px; border-radius:8px">
                    <h4 style="margin-bottom:15px; display:flex; align-items:center; gap:8px">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                            <polyline points="9 22 9 12 15 12 15 22"/>
                        </svg>
                        Productos M√°s Alquilados
                    </h4>
                    ${r.productos_mas_alquilados && r.productos_mas_alquilados.length > 0 ? r.productos_mas_alquilados.map((p, i) => `
                        <div style="display:flex; justify-content:space-between; padding:12px; background:white; border-radius:6px; margin-bottom:8px; border-left:3px solid ${i === 0 ? '#9c27b0' : i === 1 ? '#7b1fa2' : '#666'}">
                            <div>
                                <strong>${i + 1}.</strong> ${p.nombre}
                                <br><small style="color:#666">${p.tipo}</small>
                            </div>
                            <span class="badge badge-purple">${p.cantidad} veces</span>
                        </div>
                    `).join('') : '<p style="text-align:center; color:#999">No hay datos</p>'}
                </div>
            </div>
        </div>
        
        <div class="card">
            <h3 style="margin-bottom:20px; display:flex; align-items:center; gap:8px">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="20" x2="18" y2="10"/>
                    <line x1="12" y1="20" x2="12" y2="4"/>
                    <line x1="6" y1="20" x2="6" y2="14"/>
                </svg>
                Reportes Hist√≥ricos Completos
            </h3>
            ${reportesHistoricos && reportesHistoricos.length > 0 ? `
                <div style="display:grid; gap:15px">
                    ${reportesHistoricos.map(rep => `
                        <div style="background:#f9f9f9; padding:20px; border-radius:8px; display:flex; justify-content:space-between; align-items:center">
                            <div>
                                <h4 style="margin:0 0 8px 0">${rep.mes}</h4>
                                <div style="display:flex; gap:20px; font-size:14px; color:#666; flex-wrap:wrap">
                                    <span style="display:flex; align-items:center; gap:5px">
                                        üõí ${rep.total_ventas} ventas ($ ${rep.total_ingresos.toFixed(2)})
                                    </span>
                                    <span style="display:flex; align-items:center; gap:5px">
                                        üè† ${rep.total_alquileres} alquileres ($ ${rep.ingresos_alquileres.toFixed(2)})
                                    </span>
                                    <span style="display:flex; align-items:center; gap:5px">
                                        üìÖ ${rep.fecha_generacion}
                                    </span>
                                </div>
                            </div>
                            <div style="display:flex; gap:10px">
                                <button class="btn btn-primary" onclick="verReporteDetallado('${rep.id}')" style="padding:8px 16px">
                                    Ver Completo
                                </button>
                                <button class="btn btn-black" onclick="descargarReporte('${rep.id}')" style="padding:8px 16px">
                                    PDF
                                </button>
                                <button class="btn btn-danger" onclick="eliminarReporte('${rep.id}')" style="padding:8px 16px">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            ` : '<p style="text-align:center; padding:40px; color:#999">No hay reportes guardados. Genera tu primer reporte mensual completo.</p>'}
        </div>
    `;
}

async function generarReporteMensual() {
    if (!confirm('¬øDeseas generar y guardar el reporte completo del mes actual? Incluir√° ventas, alquileres, productos y m√°s.')) return;
    
    const result = await request('/api/reportes/generar', { method: 'POST' });
    
    if (result.success) {
        alert('Reporte completo generado y guardado correctamente');
        renderReportes();
    } else {
        alert('‚ùå Error al generar reporte: ' + (result.error || 'Error desconocido'));
    }
}

async function verReporteDetallado(reporteId) {
    const reporte = await request(`/api/reportes/${reporteId}`);
    
    if (!reporte) {
        alert('Error al cargar el reporte');
        return;
    }
    
    document.getElementById('modalTitle').textContent = `üìä Reporte Completo - ${reporte.mes}`;
    document.getElementById('modalBody').innerHTML = `
        <div style="max-height:600px; overflow-y:auto">
            <div class="stats-grid" style="margin-bottom:25px">
                <div style="background:#e3f2fd; padding:15px; border-radius:8px; text-align:center">
                    <div style="font-size:24px; font-weight:700; color:#1976d2">${reporte.total_ventas}</div>
                    <div style="font-size:12px; color:#666">Ventas</div>
                </div>
                <div style="background:#e8f5e9; padding:15px; border-radius:8px; text-align:center">
                    <div style="font-size:24px; font-weight:700; color:#2e7d32">$ ${reporte.total_ingresos.toFixed(2)}</div>
                    <div style="font-size:12px; color:#666">Ingresos Ventas</div>
                </div>
                <div style="background:#f3e5f5; padding:15px; border-radius:8px; text-align:center">
                    <div style="font-size:24px; font-weight:700; color:#7b1fa2">${reporte.total_alquileres}</div>
                    <div style="font-size:12px; color:#666">Alquileres</div>
                </div>
                <div style="background:#fff3e0; padding:15px; border-radius:8px; text-align:center">
                    <div style="font-size:24px; font-weight:700; color:#f57c00">$ ${reporte.ingresos_alquileres.toFixed(2)}</div>
                    <div style="font-size:12px; color:#666">Ingresos Alquileres</div>
                </div>
            </div>
            
            ${reporte.productos_mas_vendidos && reporte.productos_mas_vendidos.length > 0 ? `
                <div style="margin-bottom:25px">
                    <h4 style="display:flex; align-items:center; gap:8px; margin-bottom:15px">
                        üõí Productos M√°s Vendidos
                    </h4>
                    <table class="table">
                        <thead><tr><th>#</th><th>Producto</th><th>Tipo</th><th>Proveedor</th><th>Cantidad</th></tr></thead>
                        <tbody>
                            ${reporte.productos_mas_vendidos.map((p, i) => `
                                <tr>
                                    <td>${i + 1}</td>
                                    <td><strong>${p.nombre}</strong></td>
                                    <td><span class="badge badge-info">${p.tipo}</span></td>
                                    <td><span class="badge badge-warning">${p.proveedor || 'No especificado'}</span></td>
                                    <td><span class="badge badge-success">${p.cantidad}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            ` : ''}
            
            ${reporte.productos_mas_alquilados && reporte.productos_mas_alquilados.length > 0 ? `
                <div style="margin-bottom:25px">
                    <h4 style="display:flex; align-items:center; gap:8px; margin-bottom:15px">
                        Productos M√°s Alquilados
                    </h4>
                    <table class="table">
                        <thead><tr><th>#</th><th>Producto</th><th>Tipo</th><th>Veces Alquilado</th></tr></thead>
                        <tbody>
                            ${reporte.productos_mas_alquilados.map((p, i) => `
                                <tr>
                                    <td>${i + 1}</td>
                                    <td><strong>${p.nombre}</strong></td>
                                    <td><span class="badge badge-info">${p.tipo}</span></td>
                                    <td><span class="badge badge-purple">${p.cantidad}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            ` : ''}
            
            ${reporte.alquileres_activos && reporte.alquileres_activos.length > 0 ? `
                <div style="margin-bottom:25px">
                    <h4 style="display:flex; align-items:center; gap:8px; margin-bottom:15px">
                        Alquileres Activos (${reporte.alquileres_activos.length})
                    </h4>
                    <table class="table">
                        <thead><tr><th>Cliente</th><th>Inicio</th><th>Fin</th><th>Total</th></tr></thead>
                        <tbody>
                            ${reporte.alquileres_activos.map(a => `
                                <tr>
                                    <td><strong>${a.cliente}</strong></td>
                                    <td>${a.fecha_inicio}</td>
                                    <td>${a.fecha_fin}</td>
                                    <td><span class="badge badge-success">$ ${a.total.toFixed(2)}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            ` : ''}
        </div>
        
        <div style="margin-top:20px; display:flex; gap:10px">
            <button class="btn btn-black" onclick="descargarReporte('${reporte.id}')" style="flex:1">
                Descargar PDF
            </button>
            <button class="btn btn-primary" onclick="closeModal()">Cerrar</button>
        </div>
    `;
    document.getElementById('modalForm').classList.add('active');
}

async function descargarReporte(reporteId) {
    try {
        window.open(`/api/reportes/${reporteId}/descargar`, '_blank');
    } catch (error) {
        alert('Error al descargar reporte: ' + error.message);
    }
}

async function eliminarReporte(reporteId) {
    if (!confirm('¬øEst√°s seguro de eliminar este reporte hist√≥rico? Esta acci√≥n no se puede deshacer.')) return;
    
    try {
        const response = await fetch(`/api/reportes/${reporteId}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Reporte eliminado correctamente');
            renderReportes();
        } else {
            alert('‚ùå Error al eliminar reporte: ' + (result.error || 'Error desconocido'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error al eliminar reporte: ' + error.message);
    }
}

function closeModal() {
    document.getElementById('modalForm').classList.remove('active');
}

async function cerrarSesion() {
    if (confirm('¬øEst√°s seguro de que deseas cerrar sesi√≥n?')) {
        try {
            const response = await fetch('/logout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            const result = await response.json();
            
            if (result.success) {
                data = { 
                    productos: [], 
                    clientes: [], 
                    ventas: [], 
                    alquileres: [],
                    carrito: [], 
                    ventasOriginales: [],
                    alquileresOriginales: []
                };
                
                alert('Sesi√≥n cerrada correctamente. ¬°Hasta pronto!');
                window.location.href = '/login';
            } else {
                alert('Error al cerrar sesi√≥n: ' + (result.error || 'Int√©ntalo de nuevo'));
            }
        } catch (error) {
            console.error('Error al cerrar sesi√≥n:', error);
            alert('Error de conexi√≥n al cerrar sesi√≥n');
            window.location.href = '/login';
        }
    }
}

document.getElementById('modalForm').onclick = (e) => {
    if (e.target === document.getElementById('modalForm')) closeModal();
};

document.addEventListener('DOMContentLoaded', function() {
    currentView = 'dashboard';
    
    const panelLink = document.querySelector('[data-view="dashboard"]');
    if (panelLink) {
        panelLink.classList.add('active');
    }
    
    if (!isInitialized) {
        showView('dashboard');
        isInitialized = true;
    }
});
// ==================== FUNCI√ìN PARA VALIDAR SOLO N√öMEROS ====================

function soloNumeros(event) {
    const charCode = event.which ? event.which : event.keyCode;
    // Permitir solo n√∫meros (48-57) y teclas especiales (8=backspace, 46=delete, etc)
    if (charCode > 31 && (charCode < 48 || charCode > 57)) {
        event.preventDefault();
        return false;
    }
    return true;
}

// ==================== FUNCI√ìN PARA VALIDAR TEL√âFONO EN TIEMPO REAL ====================

function validarTelefonoInput(input) {
    const telefono = input.value;
    const errorElement = document.getElementById('telefonoError');
    const btnGuardar = document.getElementById('btnGuardarCliente');
    
    // Remover cualquier car√°cter que no sea n√∫mero
    input.value = telefono.replace(/\D/g, '');
    
    // Si tiene contenido, validar longitud
    if (input.value.length > 0) {
        if (input.value.length === 10) {
            // Tel√©fono v√°lido
            input.style.borderColor = '#2e7d32';
            input.style.backgroundColor = '#e8f5e9';
            errorElement.style.display = 'none';
            btnGuardar.disabled = false;
        } else {
            // Tel√©fono inv√°lido
            input.style.borderColor = '#d32f2f';
            input.style.backgroundColor = '#ffebee';
            errorElement.style.display = 'block';
            btnGuardar.disabled = true;
        }
    } else {
        // Sin contenido (permitido ya que no es obligatorio)
        input.style.borderColor = '';
        input.style.backgroundColor = '';
        errorElement.style.display = 'none';
        btnGuardar.disabled = false;
    }
}
    </script>
</body>
</html>